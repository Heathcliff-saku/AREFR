# ğŸ³ AREFR ä½¿ç”¨æ‰‹å†Œ

![alt text](md/framework.jpg)

è¯¥æ–‡æ¡£ä¸º äººè„¸è¯†åˆ«å¯¹æŠ—é²æ£’æ€§è¯„ä¼°å¹³å°(AREFR) çš„ä¸­æœŸæŠ¥å‘Šæš¨è§£é‡Šæ€§æ–‡æ¡£(ä¸­æ–‡ç‰ˆ)ï¼Œæˆ‘ä»¬æ—¨åœ¨å‘ä½¿ç”¨è€…è¯´æ˜è¯¥å·¥ç¨‹çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ä¸”æ–¹ä¾¿ä¹‹åçš„æ‰©å±•å¼€å‘

>å¼€å‘è€…:  è¥¿å®‰ç”µå­ç§‘æŠ€å¤§å­¦äººå·¥æ™ºèƒ½å­¦é™¢ *Silvester_Ruanã€LYC* 

---
## ğŸš€ï¼ 2022.3.27 æ›´æ–° 


<center class="half">
<img src="./md/2.png" width=200/>
<img src="./md/1.png" width=193/>
</center>


- å®ç°äº†ç‰©ç†è´´çº¸æ”»å‡»(ç›®å‰åœ¨æ•°å­—ç¯å¢ƒä¸‹æµ‹è¯•ä¸­æœ‰æ•ˆ)
  
  ç®—æ³•æ¡†æ¶é‡‡ç”¨äº†PGDæ”»å‡»çš„å½¢å¼ï¼Œåœ¨æ¯æ¬¡è¿­ä»£æ—¶ï¼Œåªæ›´æ–°ç‰¹å®šåŒºåŸŸ(çœ¼é•œåŒºåŸŸå’Œå£ç½©åŒºåŸŸ)çš„æ‰°åŠ¨

- ä½ å¯ä»¥åœ¨ `./Attack/PhysicalAttack.py` ä¸­è®¾ç½®åŒºåŸŸä»¥åŠæ”»å‡»å‚æ•°


## é›¶ã€å®‰è£…AREFRåŠç›¸å…³ç¯å¢ƒ

0.1ã€å…‹éš†é¡¹ç›®åˆ°æœ¬åœ°ï¼š
```
git clone https://github.com/Heathcliff-saku/AREFR.git
```
0.2ã€æ–°å»ºcondaè™šæ‹Ÿç¯å¢ƒ å¹¶æ¿€æ´»ï¼š
```
conda create -n AREFR python=3.9
Linux:  source activate AREFR
Windows: activate AREFR
```
0.3ã€å®‰è£…ä¾èµ–åº“ï¼š
```
pip install -r requirements.txt
```
0.4ã€å®‰è£… pytorch -gpu ç‰ˆæœ¬(æ³¨æ„æ‚¨çš„ç”µè„‘CUDAç‰ˆæœ¬)

é¡¹ç›®é‡‡ç”¨torch 1.10 CUDA 11.2ç‰ˆæœ¬

```
è®¿é—® https://pytorch.org/get-started/locally/ å®‰è£…åˆé€‚çš„torchç‰ˆæœ¬
```

## ä¸€ã€å·¥ç¨‹æ–‡ä»¶ç»“æ„
è¯¥é¡¹ç›®ä¸»è¦å…³æ³¨äººè„¸è¯†åˆ«æ¨¡å‹ä¸‹çš„å¯¹æŠ—é²æ£’æ€§æµ‹è¯•ï¼Œ å¹¶ä¸”ç€é‡å…³æ³¨ç‰©ç†åœºæ™¯ä¸‹çš„æ¨¡å‹é²æ£’æ€§ã€‚ä¸»è¦ç”±äººè„¸è¯†åˆ«æ¨¡å‹ã€æ”»å‡»ç®—æ³•ã€è¯„ä¼°ä»£ç ã€å…¶ä»–å·¥å…·æ€§çš„è„šæœ¬ç»„æˆï¼Œä»¥ä¸‹æ˜¯å·¥ç¨‹æ–‡ä»¶å†…å„ä¸ªè„šæœ¬çš„è¯´æ˜:

    Â· Attack                                 : å†…å«å®ç°çš„æ”»å‡»ç®—æ³•æºä»£ç 
    Â· checkopints                            : äººè„¸è¯†åˆ«backboneæ¨¡å‹çš„è®­ç»ƒæƒé‡
    Â· data                                   : äººè„¸è¯†åˆ«æ¨¡å‹çš„æµ‹è¯•æ•°æ®
        - facebank                           : ç”¨äºæ”»å‡»æ—¶è¿›è¡Œæµ‹è¯•çš„åŸºå‡†æ•°æ®é›†é‡Œé¢åŒ…å«å¤§å‹æ•°æ®é›†ä¸­é‡‡é›†çš„äººè„¸å’Œç°å®ç”Ÿæ´»ä¸­çš„äººè„¸
        - lfw-align-128                      : LFWåŸºå‡†æµ‹è¯•é›†, ç”¨äºè®­ç»ƒåçš„æ¨¡å‹ç²¾åº¦è¯„ä¼°
        - cleaned list.txt                   : LFWæµ‹è¯•é›†çš„å¹²å‡€æ•°æ®ç´¢å¼•
        - lfw_test_pair_target_attack        : ç”¨äºæœ‰ç›®æ ‡æ”»å‡»æµ‹è¯•çš„æ•°æ®å¯¹
        - lfw_test_pair.txt                  : ç”¨äºæ— ç›®æ ‡æ”»å‡»æµ‹è¯•çš„æ•°æ®å¯¹

    Â· face_detect_feature                    : haarå’Œlbpäººè„¸æ£€æµ‹çš„ç‰¹å¾å‚æ•°
    Â· fig                                    : è¿›åŒ–é»‘ç›’æ”»å‡»çš„è¿­ä»£è¿‡ç¨‹å›¾       
    Â· model                                  : äººè„¸è¯†åˆ«æ¨¡å‹éƒ¨åˆ†
        - loss                               : è‡ªå®šä¹‰focalloss
        - metric                             : ArcFace/CosFace åº¦é‡å‡½æ•°
        - mobilenet.py                       : backbone, mobilenet
        - resnet.py                          : backbone, resnet

    Â· sample                                 : å­˜æ”¾ä¸€äº›æ‚ä¸ƒæ‚å…«çš„å›¾åƒ, æ¯”å¦‚çœ¼é•œå£ç½©çš„å›¾åƒ, ä»¥åŠä¸€äº›æµ‹è¯•å›¾åƒ
    Â· attack_evaluate.py                     : æ”»å‡»æ•ˆæœè¯„ä¼°ä»£ç 
    Â· attack_example.py                      : ç”Ÿæˆå•ä¸ªå¯¹æŠ—æ ·æœ¬çš„ä»£ç 
    Â· config.py                              : å·¥ç¨‹çš„æ‰€æœ‰è¶…å‚æ•°è®¾ç½®
    Â· dataset.py                             : è®­ç»ƒæ•°æ®çš„æ‰¹é‡è¯»å–

    Â· demo.py                                : äººè„¸æ£€æµ‹ä¸è¯†åˆ«ç³»ç»Ÿçš„è¿è¡Œä»£ç 
    Â· face_alignment.py                      : å·¥å…·è„šæœ¬ â€” äººè„¸å¯¹é½
    Â· feature_dict.pkl                       : facebankå†…æ‰€æœ‰äººç‰©çš„ç‰¹å¾å‘é‡æ–‡ä»¶, åœ¨è¿è¡Œdemoæ—¶é»˜è®¤é‡æ–°è®¡ç®—ä¸€é

    Â· put_glass.py                           : å·¥å…·è„šæœ¬ â€” æ·»åŠ çœ¼é•œ
    Â· put_mask.py                            : å·¥å…·è„šæœ¬ â€” æ·»åŠ å£ç½©
    Â· shape_predictor_68_face_landmarks.dat  : ç”¨äºé¢éƒ¨æ£€æµ‹å’Œäººè„¸å¯¹é½çš„68ç‚¹ç‰¹å¾æ–‡ä»¶
    Â· take_picture.py                        : å·¥å…·è„šæœ¬ â€” å‘facebankå†…æ·»åŠ ä»»åŠ¡, å…è®¸ç”¨æˆ·è¿›è¡Œæ‹ç…§å’Œä¸Šä¼ ç…§ç‰‡

    Â· test.py                                : äººè„¸è¯†åˆ«æ¨¡å‹è®­ç»ƒåçš„æµ‹è¯•ä»£ç 
    Â· train.py                               : äººè„¸è¯†åˆ«æ¨¡å‹è®­ç»ƒä»£ç 
    Â· utils.py                               : ä¸€äº›å·¥å…·å‡½æ•°


## äºŒã€ç½‘ç»œè®­ç»ƒå’Œæµ‹è¯•
å…³äºäººè„¸è¯†åˆ«ç½‘ç»œæ­å»ºå’Œè®­ç»ƒæµ‹è¯•æµç¨‹ï¼Œè¯¦ç»†å‚è€ƒäº† [Build-Your-Own-Face-Model](https://github.com/siriusdemon/Build-Your-Own-Face-Model)

### 2.1 å—å®³æ¨¡å‹
åœ¨äººè„¸è¯†åˆ«çš„å—å®³æ¨¡å‹ä¸Š, é¡¹ç›®ç›®å‰æ”¯æŒå››ç§æ¨¡å‹çš„è®­ç»ƒ:

    1ã€ArcFace + mobilenet
    2ã€ArcFace + resnet
    3ã€CosFace + mobilenet
    4ã€CosFace + resnet

åœ¨ *conf.py* å†…å¯ä»¥ä¿®æ”¹

```python
""" æ¨¡å‹ è¶…å‚æ•°"""
backbone = 'fmobile'  # ['resnet', 'fmobile']
metric = 'arcface'  # ['cosface', 'arcface']
```
### 2.2 æ¨¡å‹è®­ç»ƒ
åœ¨ç»ˆç«¯å†…è¾“å…¥ 
```python
python train.py
```
å³å¯ä½¿ç”¨é»˜è®¤è¶…å‚æ•°è¿›è¡Œæ¨¡å‹è®­ç»ƒï¼Œè‹¥éœ€è¦ä¿®æ”¹å‚æ•°ï¼Œæˆ‘ä»¬æä¾›ä¸¤ç§æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥åœ¨*conf.py* å†…ä¿®æ”¹ï¼Œæˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¯ä¿®æ”¹çš„è¶…å‚æ•°åŠå…¶è¯´æ˜ï¼š
```python
python train.py -h
```
ç›®å‰æ”¯æŒçš„å¯ä¿®æ”¹çš„è¶…å‚æ•°ä¸ºï¼š

| è¶…å‚æ•°åç§° | å«ä¹‰ | å¯é€‰å€¼æˆ–æ•°æ®ç±»å‹ | é»˜è®¤å€¼|
| :---------: | :----: | :----: | :----: |
| --backbone | è®¾ç½®ä¸»å¹²ç½‘ç»œé‡‡ç”¨çš„æ¨¡å‹ | `'resnet'` `'fmobile'` |`'fmobile'`
| --metric | ç½‘ç»œè®­ç»ƒæ—¶è®¡ç®—æŸå¤±é‡‡ç”¨çš„è·ç¦»åº¦é‡å‡½æ•° | `'cosface'` `'arcface'` |`'arcface'`
| --loss | ç½‘ç»œè®­ç»ƒæ—¶çš„æŸå¤±å‡½æ•° | `'focal_loss'` `'cross_entropy'`|`'focal_loss'`
| --optimizer | æ¢¯åº¦ä¸‹é™ä½¿ç”¨çš„ä¼˜åŒ–å™¨ | `'sgd'` `'adam'` |`'sgd'`
| --batch_size | ä¸€ä¸ªæ‰¹æ¬¡çš„æ ·æœ¬æ•°é‡ | **int** |8
| --epoch | è®­ç»ƒè½®æ•° | **int** | 60
| --lr | æ¢¯åº¦ä¸‹é™å­¦ä¹ ç‡ | **float** | 0.1


ä¾‹å¦‚ï¼š
```python
python train.py --backbone='fmobile' --epoch=2 --lr=0.001 
```
### 2.3 æ¨¡å‹æµ‹è¯•
ç›®å‰åªæ”¯æŒLFWåŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥å¼•å…¥æ›´å¤šçš„æµ‹è¯•åŸºå‡†
> LFW(æ— çº¦æŸè‡ªç„¶åœºæ™¯äººè„¸è¯†åˆ«æ•°æ®é›†)ï¼Œè¯¥æ•°æ®é›†ç”±13000å¤šå¼ å…¨ä¸–ç•ŒçŸ¥åäººå£«äº’è”ç½‘è‡ªç„¶åœºæ™¯ä¸åŒæœå‘ã€è¡¨æƒ…å’Œå…‰ç…§ç¯å¢ƒäººè„¸å›¾ç‰‡ç»„æˆï¼Œå…±æœ‰5000å¤šäººï¼Œå…¶ä¸­æœ‰1680äººæœ‰2å¼ æˆ–2å¼ ä»¥ä¸Šäººè„¸å›¾ç‰‡ã€‚æ¯å¼ äººè„¸å›¾ç‰‡éƒ½æœ‰å…¶å”¯ä¸€çš„å§“åIDå’Œåºå·åŠ ä»¥åŒºåˆ†ã€‚

åœ¨LFWéšæœºé€‰å–æµ‹è¯•å¯¹6000å¯¹ï¼Œè¿›è¡Œæ¨¡å‹æµ‹è¯•ï¼Œè¯·è¿è¡Œ
```python
python test.py
```

## ä¸‰ã€å¦‚ä½•è¿è¡ŒAREFRäººè„¸è¯†åˆ«ç³»ç»Ÿ

### 3.1 æ„å»ºè‡ªå·±çš„é¢éƒ¨ç‰¹å¾åº“ 

è®­ç»ƒå®Œæˆåçš„äººè„¸è¯†åˆ«æ¨¡å‹å¯ä»¥å°†ä¸åŒçš„ç”¨æˆ·é¢éƒ¨è¾“å‡ºä¸º ä½™å¼¦è·ç¦»å€¼è¾ƒå¤§çš„ç‰¹å¾å‘é‡ï¼Œä¸ºäº†å®ç°æœ¬åœ°çš„äººè„¸è¯†åˆ«ï¼Œéœ€è¦é¦–å…ˆæ„å»ºå¥½é¢éƒ¨ç‰¹å¾åº“

ä¸ºæ­¤ï¼Œæˆ‘ä»¬æä¾›äº†ç…§ç‰‡é‡‡é›†çš„è„šæœ¬`take_picture.py`

å‡è®¾ç°åœ¨éœ€è¦é‡‡é›†æŸä¸ªç”¨æˆ·çš„é¢éƒ¨å›¾åƒï¼Œé¦–å…ˆï¼Œåœ¨`conf.py`å†…ä¿®æ”¹`name`å‚æ•°ä¸ºè¯¥ç”¨æˆ·çš„å§“åæ ‡è¯†ï¼ˆå¦‚'rsw'ï¼‰

æœ‰ä¸¤ç§æ–¹æ³•è¿›è¡Œäººè„¸é‡‡é›†

- ä½¿ç”¨æ‘„åƒå¤´(é»˜è®¤)ï¼šå®šä¹‰å®Œ`name`åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŒ‰ä¸‹tè¿›è¡Œæ‹æ‘„æ•è·äººè„¸
```python
python take_picture.py
```
- ä¼ å…¥ç…§ç‰‡(ä¿®æ”¹`conf.py`å†…çš„`use_cam`)ï¼šå°†`face_img`æ”¹ä¸ºå›¾åƒçš„åœ°å€ï¼Œå¹¶è¿è¡Œ
```python
python take_picture.py
```
ä¹‹åï¼Œæ•è·å¹¶è£å‰ªåçš„é¢éƒ¨å›¾åƒå°†å­˜å…¥ `./data/facebank/name` ä¸­


### 3.2 è¿è¡Œäººè„¸è¯†åˆ«ç³»ç»Ÿ 

åœ¨å®Œæˆå›¾åƒé‡‡é›†åï¼Œè¿è¡Œ `demo.py` æ–‡ä»¶ï¼Œè‹¥facebankå­˜åœ¨æ–°çš„ç”¨æˆ·ï¼Œè¯·ä¿®æ”¹ `conf.py` å†…çš„ `update_feature_dict = True` ã€‚æ­¤æ—¶è¿è¡Œdemoç¨‹åºå°†é¦–å…ˆæ›´æ–°facebankå†…ç”¨æˆ·çš„ç‰¹å¾åº“ä¿¡æ¯ã€‚æ¥ä¸‹æ¥ä¾¿å¯çœ‹è§äººè„¸è¯†åˆ«ç³»ç»Ÿçš„å›¾å½¢åŒ–ç•Œé¢ã€‚

> PSï¼šç®—æ³•é»˜è®¤é‡‡å–æ¯å¸§å›¾åƒå¹¶å®æ—¶è®¡ç®—ï¼Œè¿™å°†æ¶ˆè€—å¤§é‡çš„è®¡ç®—èƒ½åŠ›ã€‚è‹¥ç”¨æˆ·çš„CPUæ€§èƒ½è¾ƒå¼±ï¼Œå¯ä»¥ä¿®æ”¹ `conf.py` å†…çš„ `is_realtime = False` ã€‚æ­¤æ—¶ç³»ç»Ÿå°†ä¸å¼€å¯å®æ—¶è®¡ç®—ï¼Œé€šè¿‡æŒ‰é”® `t` æ•è·ä¸€å¸§å›¾åƒè¿›è¡Œæ£€æµ‹

## å››ã€æ•°å­—ç¯å¢ƒä¸‹çš„äººè„¸è¯†åˆ«ç³»ç»Ÿæ”»é˜²
### 4.1 ç”Ÿæˆå•å¼ äººè„¸å¯¹æŠ—æ ·æœ¬
ç›®å‰æä¾›5ç§é’ˆå¯¹ç™½ç›’æ¨¡å‹çš„æ”»å‡»ç®—æ³•ï¼š
- *[Goodfellow et al.]*:  FGSM (Fast Gradient Sign Method)
- *[Kurakin et al.]* : BIM (Basic Iterative Method)
- *[Dong et al.]*: MIM (Momentum Iterative Method)
- *[Madry et al.]*: PGD (Projected Gradient Descent)
- *[Carlini et al.]*: C&W (Carlini & Wagner Attack)

ä»¥åŠä¸»è¦é’ˆå¯¹é»‘ç›’æ¨¡å‹çš„æ”»å‡»ç®—æ³•ï¼š
- *[Dong et al.]*: Evolutionary Attack

`attack_example.py` æä¾›äº†ç”Ÿæˆå•å¼ é¢éƒ¨å¯¹æŠ—æ ·æœ¬çš„æ¡ˆä¾‹

1ã€æŒ‡å®šé‡‡ç”¨æŸç§æ”»å‡»ç®—æ³•:
```python
attack_method = FacePGD(victim_model)
```
å…­ç§ç®—æ³•å¯¹åº”çš„ç±»åç§°ä¸ºï¼š`FaceFGSM` `FaceBIM`  `FaceMIFGSM` `FacePGD` `FaceCW` `Evolutionary` 

2ã€ç”Ÿæˆå•å¼ å¯¹æŠ—æ ·æœ¬ï¼š
```python
digtal_single_test(input_x_root, target_x_root, attack_method, victim_model)
```

3ã€æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹ `attack_example.py` çš„ä»¥ä¸‹éƒ¨åˆ†å¹¶è¿è¡Œï¼š
```python
if mode == 'digtal':
        """
        digtal attack flow
        you first need Specify attack method
        """
        attack_method = FacePGD(victim_model)
        # attack_method = FaceCW(victim_model)
        # attack_method = FaceFGSM(victim_model)
        # attack_method = FaceBIM(victim_model)
        # attack_method = FaceMIFGSM(victim_model)
        # attack_method = Evolutionary(victim_model)

        """ then give the root of input and attack target """
        input_x_root = './data/facebank/rsw/1.jpg'  # true: rsw
        target_x_root = './data/facebank/Yao_Ming/Yao_Ming_0001.jpg'  # target: zqy
        digtal_single_test(input_x_root, target_x_root, attack_method, victim_model)
```

### 4.2 äººè„¸è¯†åˆ«æ¨¡å‹é²æ£’æ€§è¯„ä¼°ï¼š
æ‰¹é‡ç”Ÿæˆå¯¹æŠ—æ ·æœ¬ï¼Œå¹¶é’ˆå¯¹æ¨¡å‹çš„é²æ£’æ€§è¿›è¡Œè¯„ä¼°ã€‚
é‡‡ç”¨LFWæ•°æ®é›†ä¸­çš„6000ä¸ªä¸åŒé¢éƒ¨æ ·æœ¬å¯¹è¿›è¡Œæ¨¡ä»¿æ”»å‡»ï¼š
è¿è¡Œ `attack_evaluate.py` 

æŒ‡å®šæ”»å‡»ç®—æ³•éƒ¨åˆ†ä¸4.1æè¿°ä¸€è‡´